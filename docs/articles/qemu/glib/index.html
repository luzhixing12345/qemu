<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/qemu.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">glib</a><ul><li><a href="#h2-1">hashtable</a></li></ul><ul><li><a href="#h2-2">事件循环</a><ul><li><a href="#h3-3">基础用法</a></li></ul><ul><li><a href="#h3-4">自定义事件源</a></li></ul><ul><li><a href="#h3-5">IO自定义事件</a></li></ul></li></ul><ul><li><a href="#h2-6">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">glib</h1><p>Glib 是一个广泛使用的 C 语言库,提供了许多数据结构、线程、消息传递、对象系统和其他功能.许多大型和知名的开源项目都使用了 Glib, 如 QEMU/GNOME/GTK/Systemd.</p><p>glib 的代码封装的很完善, 这里我们先介绍几种十分常见且有用的函数接口</p><pre class="language-shell"><code><span class="Token Program ID">sudo</span><span class="Token SPACE"> </span><span class="Token ID">apt</span><span class="Token SPACE"> </span><span class="Token ID">install</span><span class="Token SPACE"> </span><span class="Token ID">libglib2.0-dev</span></code></pre><p>编译的时候</p><pre class="language-makefile"><code><span class="Token Variable ID">CFLAGS</span><span class="Token SPACE"> </span><span class="Token ADD_ASSIGN">+=</span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token ID">pkg-config</span><span class="Token SPACE"> </span><span class="Token OPTION">--cflags</span><span class="Token SPACE"> </span><span class="Token ID">glib-2.0</span><span class="Token BACKTICK">`</span><span class="Token LF">
</span><span class="Token Variable ID">LDFLAGS</span><span class="Token SPACE"> </span><span class="Token ASSIGN">=</span><span class="Token SPACE"> </span><span class="Token OPTION">-pthread</span><span class="Token SPACE"> </span><span class="Token BACKTICK">`</span><span class="Token ID">pkg-config</span><span class="Token SPACE"> </span><span class="Token OPTION">--libs</span><span class="Token SPACE"> </span><span class="Token ID">glib-2.0</span><span class="Token BACKTICK">`</span></code></pre><h2 id="h2-1">hashtable</h2><p>C 并没有原生的 hashtable 的实现, GLib 提供了 <code>GHashTable</code>,它是一个高效的哈希表实现.你可以使用它来存储键值对,并进行插入、删除、查找和遍历操作. 如下是一个简单的使用案例</p><pre class="language-c"><code><span class="Token COMMENT">// src/glib/hashtable.c</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">glib.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdio.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">MyData</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">x</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">y</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// 回调函数,用于处理每个键值对</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">print_key_value</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">key</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">value</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Key: </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">, Value: </span><span class="Token Format String STRING">%s</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">value</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">MyData</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">MyData</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">user_data</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;x = </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">, y = </span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">data</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">x</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">data</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">y</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// 创建一个哈希表</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GHashTable</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">hash_table</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">g_str_hash</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">g_str_equal</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// 添加键值对到哈希表</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_insert</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;name&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;Alice&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_insert</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;city&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;Wonderland&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_insert</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;occupation&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;Adventurer&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 查找键值对</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">name</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_lookup</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;name&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">name</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Found: Key: name, Value: </span><span class="Token Format String STRING">%s</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">name</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Key &#x27;name&#x27; not found</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 删除键值对</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_remove</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;city&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 检查键值对是否存在</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_contains</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;city&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Key &#x27;city&#x27; found</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Key &#x27;city&#x27; not found</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 使用 g_hash_table_foreach 遍历哈希表</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">MyData</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Constant PrimaryExpression NUMBER">10</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">20</span><span class="Token Initializer InitDeclarator BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_foreach</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">print_key_value</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">data</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 销毁哈希表</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_hash_table_destroy</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">hash_table</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><ol start="1"><li><b>创建哈希表</b>:使用 <code>g_hash_table_new</code> 创建一个哈希表,其中键和值都是字符串.</li></ol><ol start="2"><li><b>添加键值对</b>:使用 <code>g_hash_table_insert</code> 向哈希表中添加键值对.</li></ol><ol start="3"><li><b>查找键值</b>: 使用 <code>g_hash_table_lookup</code> 查找元素值, 使用 <code>g_hash_table_contains</code> 判断元素是否存在</li></ol><ol start="4"><li><b>遍历哈希表</b>:使用 <code>g_hash_table_foreach</code> 遍历哈希表,并对每个键值对调用回调函数 <code>print_key_value</code>.</li></ol><ol start="5"><li><b>回调函数</b>:<code>print_key_value</code> 打印每个键值对.</li></ol><ol start="6"><li><b>销毁哈希表</b>:使用 <code>g_hash_table_destroy</code> 销毁哈希表,释放内存.</li></ol><p><code>g_hash_table_foreach</code> 是 GLib 提供的一个函数,用于遍历哈希表(<code>GHashTable</code>)中的所有键值对,并对每个键值对执行指定的回调函数.它的函数签名如下:</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">g_hash_table_foreach</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GHashTable</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">hash_table</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GHFunc</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">func</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li><code>hash_table</code>:要遍历的哈希表.</li></ul><ul><li><code>func</code>:用于处理每个键值对的回调函数,类型为 <code>GHFunc</code>.</li></ul><ul><li><code>user_data</code>:传递给回调函数的用户数据.</li></ul><p><code>GHFunc</code> 是一个函数指针类型,其定义如下:</p><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP Typedefine TYPEDEF_ID">GHFunc</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">key</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">value</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li><code>key</code>:哈希表中的一个键.</li></ul><ul><li><code>value</code>:与该键关联的值.</li></ul><ul><li><code>user_data</code>:传递给 <code>g_hash_table_foreach</code> 的用户数据.</li></ul><p><b>如果需要传入多个参数传给 user_data 可以创建一个结构体传入</b></p><h2 id="h2-2">事件循环</h2><p>QEMU 作为一个持续运行的状态机, 需要不停地检查是否有新事件发生, 如果发生那么执行对应的一些处理. 我们可能会写出一个常见的 while 循环</p><pre class="language-c"><code><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-0 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token IterationStatement BraceDepth-0 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">something_happened</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">do_something</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// ...</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement IterationStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>但是实际情况可能比较复杂, 比如希望间隔 0.1 秒执行一次, 事件触发对应的回调函数, 可以在循环过程中注册新事件, 删除某些事件等等. glib 提供了一种简洁的事件循环接口</p><p>GLib 实现了一个功能强大的事件循环分发处理机制,被抽象成为 GMainLoop,用于循环处理事件源上的事件.每个 GMainLoop 都工作在指定的 GMainContext 上.事件源在 GLib 中则被抽象成了 GSource.在 GMainContext 中有一个 GSource 列表.GLib 内部定义实现了三种类型的事件源,分别是 Idle, Timeout 和 I/O.同时也支持创建自定义的事件源</p><h3 id="h3-3">基础用法</h3><p>下面是一个简单的示例, 首先创建了一个主循环 loop. 然后使用 <code>g_timeout_add</code> 注册了两个回调事件. 第一个参数为间隔时间, 第二个参数为回调函数指针, 第三个参数是传参</p><p>然后通过 <code>g_main_loop_run</code> 进入主循环, 这是一个 while 死循环, 此时程序会执行所有的注册事件. 执行效果如下图所示</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">glib.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdio.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">count_down</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">cancel_fire</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainLoop</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">loop</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_timeout_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">500</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">count_down</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression HighlightLine ID">NULL</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_timeout_add</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">8000</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">cancel_fire</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_main_loop_run</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier FunctionName DirectDeclaractor FunctionName FunctionName ID">count_down</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">counter</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">10</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">counter</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;-----[FIRE]-----</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;-----[% 4d]-----</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">counter</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">TRUE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier FunctionName DirectDeclaractor FunctionName FunctionName ID">cancel_fire</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainLoop</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">loop</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">data</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;-----[QUIT]-----</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_quit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>代码见 <a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/event_loop.c" target="_blank">event_loop.c</a></p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/sdmkl9l.gif"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/sdmkl9l.gif" alt="sdmkl9l"></a></p><p><code>GMainLoop</code> 表示一个主事件循环.</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">GMainLoop</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">g_main_loop_new</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainContext</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">context</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">is_running</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li><code>context</code>: 事件循环的上下文.传 <code>NULL</code> 使用默认上下文.<p>每个 GMainLoop 都工作在指定的 GMainContext 上, 可以创建多个 loop, 也可以通过 <code>g_main_loop_get_context</code> 获取某个 loop 所在的 context</p><blockquote><p>代码见 <a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/multi_context.c" target="_blank">multi_context.c</a></p></blockquote></li></ul><ul><li><code>is_running</code>: 初始状态是否运行.通常传 <code>FALSE</code>.</li></ul><p><code>g_timeout_add</code> 用于在指定时间间隔后调用回调函数.</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">guint</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">g_timeout_add</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">guint</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">interval</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSourceFunc</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">function</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><ul><li><code>interval</code>: 超时时间,单位为毫秒.</li></ul><ul><li><code>function</code>: 超时触发时调用的回调函数.</li></ul><ul><li><code>data</code>: 传递给回调函数的用户数据.</li></ul><p>回调函数用于处理事件.示例中有两个回调函数 <code>count_down</code> 和 <code>cancel_fire</code>, 返回值代表是否继续运行</p><ol start="1"><li><b>创建主事件循环</b>:<code>g_main_loop_new</code> 创建一个新的 <code>GMainLoop</code> 实例.</li></ol><ol start="2"><li><b>添加超时事件</b>:<code>g_timeout_add</code> 添加两个超时事件,一个每 500 毫秒调用 <code>count_down</code>,另一个 8000 毫秒后调用 <code>cancel_fire</code>.</li></ol><ol start="3"><li><b>运行主事件循环</b>:<code>g_main_loop_run</code> 启动事件循环,直到调用 <code>g_main_loop_quit</code> 退出循环.</li></ol><ol start="4"><li><b>退出和清理</b>:在 <code>cancel_fire</code> 中调用 <code>g_main_loop_quit</code> 退出事件循环,最后调用 <code>g_main_loop_unref</code> 释放 <code>GMainLoop</code> 实例.</li></ol><h3 id="h3-4">自定义事件源</h3><p>上例中我们创建了两个定时执行的函数, 但同时我们也希望可以注册一些自定义事件, 即当某些事情发生时执行某些操作, 并且可以灵活的添加删除终止</p><p>我们先来思考一下, 如何检查事件源是否有事件发生? 我们可以把事件源分为两类:</p><ol start="1"><li>不与文件描述符关联的事件, 通常是一些纯粹的<b>逻辑或定时事件</b></li></ol><ol start="2"><li>与文件描述符相关联的事件, 例如网络套接字、管道或文件. poll 用于等待这些文件描述符的状态变化,如可读、可写或出现错误, <b>只有轮询文件之后,才能知道文件事件是否发生</b>.<blockquote><p>详见 <a href="https://luzhixing12345.github.io/klinux/articles/kernel/poll/" target="_blank">poll</a></p></blockquote></li></ol><p>glib 的事件循环的逻辑如下</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240807095839.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240807095839.png" alt="20240807095839"></a></p><ul><li><code>prepare</code>:调用每个事件源的 prepare 回调函数,检查事件源是否有事件发生. 函数签名如下<pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">prepare</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gint</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">timeout</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>source 指向当前正在处理的事件源. timeout 指示事件源希望主循环等待的最长时间(以毫秒为单位).</p><p>如果返回值为 <code>TRUE</code> 说明该事件可以<b>立即处理</b>(例如idle类程序), 此时 <b>timeout 参数无效</b>.</p><p>如果返回值为 <code>FALSE</code>, 则说明该事件等待 timeout 后处理.</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240808003303.png"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240808003303.png" alt="20240808003303"></a></p></li></ul><ul><li><code>query</code>:获取需要 poll 的文件 fd, 如果 prepare 返回 TRUE 则会直接跳过进入 dispatch 阶段</li></ul><ul><li><code>check</code>:检查事件源是否有事件发生, 此时可以判断 poll 的状态</li></ul><ul><li><code>dispatch</code>: 事件处理函数</li></ul><p>我们先来看一个简单的自定义延迟事件, 自定义的事件源是一个继承 <code>GSource</code> 的结构体,即自定义事件源的结构体的第一个成员是 <code>GSource</code> 结构体, 其后便可放置程序所需数据. 整体的执行流程逻辑如下</p><ul><li>g_main_loop_run 通过调用事件源的 prepare 接口并判断其返回值以确定各事件源是否作好准备. 该事件返回 FALSE, 延迟 1000ms</li></ul><ul><li>此时 Glib 后端会在 polling 阶段检查所有 fd 的状态(在本例中不存在), 完成后再次询问该事件源是否作好准备,这一过程是通过调用事件源的 check 接口而实现的,如果事件源依然未作好准备,即 check 接口的返回 FALSE,那么 g_main_loop_run 会让主事件循环进入睡眠状态.主事件循环的睡眠时间是步骤 a 中遍历时间源时所统计的最小时间间隔,例如在 prepare 接口中可以像下面这样设置时间间隔.到达一定时间后, g_main_loop_run 会唤醒主事件循环,再次询问.如此周而复始,<b>直至事件源的 check 接口返回值为 TRUE</b>.</li></ul><ul><li>此时 g_main_loop_run 会调用事件源的 dispatch 接口,由该接口调用事件源的响应函数.事件源的响应函数是回调函数,可使用 g_source_set_callback 函数进行设定</li></ul><blockquote><p><a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/custom_delay.c" target="_blank">custom_delay.c</a></p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">glib.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">glib/gprintf.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">source</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">gchar</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">text</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression TypeSpecifier NUMBER">256</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">counter</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">MySource</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">prepare</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gint</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">timeout</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function HighlightLine SPACE">    </span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">timeout</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">1000</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword JumpStatement HighlightLine RETURN">return</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">FALSE</span><span class="Token JumpStatement HighlightLine SEMI">;</span><span class="Token JumpStatement HighlightLine LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">check</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">TRUE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">dispatch</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSourceFunc</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">callback</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MySource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mysource</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MySource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">callback</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">callback</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mysource</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">text</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mysource</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">counter</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">mysource</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">counter</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Counter: </span><span class="Token Format String STRING">%d</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">mysource</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">counter</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">TRUE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">finalize</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Source finalized</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">my_callback_func</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">text</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">user_data</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_print</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;callback func:</span><span class="Token Format String STRING">%s</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">text</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainLoop</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">loop</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">TRUE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainContext</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">context</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_get_context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier HighlightLine TYPEDEF_ID">GSourceFuncs</span><span class="Token Keyword Typedefine TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier DirectDeclaractor HighlightLine ID">source_funcs</span><span class="Token Identifier DirectDeclaractor HighlightLine SPACE"> </span><span class="Token InitDeclarator HighlightLine ASSIGN">=</span><span class="Token InitDeclarator HighlightLine SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-1 HighlightLine LCURLY_BRACE">{</span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">prepare</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">check</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">dispatch</span><span class="Token HighlightLine COMMA">,</span><span class="Token HighlightLine SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression HighlightLine ID">finalize</span><span class="Token Initializer InitDeclarator BraceDepth-1 HighlightLine RCURLY_BRACE">}</span><span class="Token Declaration HighlightLine SEMI">;</span><span class="Token Declaration HighlightLine LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier HighlightLine TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor HighlightLine ID">source</span><span class="Token Identifier DirectDeclaractor HighlightLine SPACE"> </span><span class="Token InitDeclarator HighlightLine ASSIGN">=</span><span class="Token InitDeclarator HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_source_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">source_funcs</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Keyword UnaryExpression HighlightLine SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier HighlightLine TYPEDEF_ID">MySource</span><span class="Token UnaryExpression CastExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token Declaration HighlightLine SEMI">;</span><span class="Token Declaration HighlightLine LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_sprintf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MySource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">text</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;Hello world!&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MySource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">counter</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">5</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_source_set_callback</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">my_callback_func</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MySource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-0 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">text</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_source_attach</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">source</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_run</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_context_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_source_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>另一个复杂一些的键盘输入案例见 <a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/keyboard_event_loop.c" target="_blank">keyboard_event_loop.c</a></p></blockquote><h3 id="h3-5">IO自定义事件</h3><p>I/O 类型的事件源要稍微难理解一些,因为涉及到了操作系统层面的 poll 机制.所谓 poll 机制,就是操作系统提供的对文件描述符所关联的 I/O 的状态监视功能 ,例如向文件中写入数据 ,那么 I/O 的状态可以表示为 <code>POLLOUT</code>, 而从文件中读取数据,那么 I/O 的状态就变为 <code>POLLIN</code>.</p><p>GLib 为 Unix 系统与Windows 系统的 poll 机制进行了封装,并且可以将文件与主事件循环的事件源建立关联,在主循环的过程中, g_main_loop_run 会轮询各个关联到文件的事件源,并处理相应的事件响应.</p><p>下面是一个简单的案例, 首先自定义事件中使用 <code>GPollFD</code> 保存所有监听的文件描述符, 本例中只有标准输入 <code>STDIN_FILENO</code>. 监听其输入 <code>POLLIN</code> 事件并使用 <code>g_source_add_poll</code> 添加到 Glib 监听列表</p><p>prepare 中返回值 FALSE 说明该资源需要等待, timeout 设置为 -1 说明无限等待来自键盘的 POLL 事件. 这里的会传入 poll 的最后一个参数</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName ID">poll</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">pollfd</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fds</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">nfds_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nfds</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">timeout</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>当 poll 返回并且 check 判断确实是 <code>POLLIN</code> 事件则进入 dispatch 处理</p><blockquote><p><a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/poll.c" target="_blank">poll.c</a></p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">fcntl.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">glib.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">poll.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">stdio.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token HeaderName ControlLine BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token String HeaderName STRING">unistd.h</span><span class="Token HeaderName ControlLine BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">source</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">GPollFD</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">poll_fd</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">FDSource</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// 自定义事件源的准备函数</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">fd_source_prepare</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gint</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">timeout</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function HighlightLine SPACE">    </span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">timeout</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine MINUS">-</span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">1</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine SPACE">  </span><span class="Token ExpressionStatement HighlightLine COMMENT">// 无限等待</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement SPACE">   </span><span class="Token JumpStatement COMMENT">// 不准备好,继续等待</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function COMMENT">// 自定义事件源的检查函数</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">fd_source_check</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fd_source</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Keyword JumpStatement HighlightLine RETURN">return</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd_source</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine DOT">.</span><span class="Token Identifier HighlightLine ID">revents</span><span class="Token Identifier HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">POLLIN</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine NE">!=</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token JumpStatement HighlightLine SEMI">;</span><span class="Token JumpStatement HighlightLine LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function COMMENT">// 自定义事件源的分派函数</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">gboolean</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">fd_source_dispatch</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSourceFunc</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">callback</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gpointer</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">user_data</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fd_source</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fd_source</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">revents</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">POLLIN</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">buf</span><span class="Token DirectDeclaractorPostfix BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">256</span><span class="Token DirectDeclaractorPostfix BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">ssize_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">len</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">read</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fd_source</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">fd</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">buf</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">buf</span><span class="Token UnaryExpression CastExpression BraceDepth-0 RPAREN">)</span><span class="Token UnaryExpression CastExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">buf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Char PrimaryExpression CHARACTER">&#x27;\0&#x27;</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">printf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Read: </span><span class="Token Format String STRING">%s</span><span class="Token Control String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">buf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">TRUE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement SPACE">  </span><span class="Token JumpStatement COMMENT">// 错误或关闭文件描述符时返回 FALSE</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function COMMENT">// 自定义事件源的销毁函数</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">fd_source_finalize</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fd_source</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">close</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">fd_source</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">fd</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSourceFuncs</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">fd_source_funcs</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Identifier FunctionName PrimaryExpression ID">fd_source_prepare</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">fd_source_check</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">fd_source_dispatch</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">fd_source_finalize</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainContext</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">context</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_context_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">       </span><span class="Token Declaration COMMENT">// 创建新的上下文</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GMainLoop</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">loop</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">context</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">FALSE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">// 使用新上下文创建主循环</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// 创建自定义事件源</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">GSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">source</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_source_new</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">fd_source_funcs</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token UnaryExpression CastExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">fd_source</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token CastExpression ConditionalExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">FDSource</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression ConditionalExpression BraceDepth-1 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd_source</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine DOT">.</span><span class="Token Identifier HighlightLine ID">fd</span><span class="Token Identifier HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">STDIN_FILENO</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine SPACE">  </span><span class="Token ExpressionStatement HighlightLine COMMENT">// 使用标准输入</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd_source</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression HighlightLine DOT">.</span><span class="Token Identifier HighlightLine ID">events</span><span class="Token Identifier HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression HighlightLine ID">POLLIN</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 将事件源的 poll_fd 注册到上下文中</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_source_add_poll</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">source</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">fd_source</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">poll_fd</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_source_attach</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token ExpressionStatement COMMENT">// 将事件源添加到指定上下文中</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_run</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token ExpressionStatement COMMENT">// 运行主循环</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_loop_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// 释放主循环</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_source_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">source</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">         </span><span class="Token ExpressionStatement COMMENT">// 释放事件源</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">g_main_context_unref</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE">  </span><span class="Token ExpressionStatement COMMENT">// 释放上下文</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>上例中我们对于来自 fd 的响应是通过 read 来接收的. Glib 中 <code>GIOChannel</code> 提供了一个更高层次的抽象,封装了 I/O 操作和错误处理,使代码更简洁和可维护. 直接使用 read 则需要更多的手动处理,包括错误检查和边界条件处理. 它可以很方便地集成到 GLib 的主循环中,通过 <code>g_io_add_watch</code> 处理异步 I/O 事件.</p><p>具体代码见 <a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/tcp_event_loop.c" target="_blank">tcp_event_loop.c</a></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/jlkioq.gif"><img loading="lazy" src="https://raw.githubusercontent.com/learner-lu/picbed/master/jlkioq.gif" alt="jlkioq"></a></p><blockquote><p><a href="https://github.com/luzhixing12345/qemu/blob/main/src/glib/channel.c" target="_blank">channel.c</a></p></blockquote><h2 id="h2-6">参考</h2><ul><li><a href="https://blog.csdn.net/u014338577/article/details/52932358" target="_blank">GLib介绍与使用</a></li></ul><ul><li><a href="https://blog.csdn.net/song_lee/article/details/116809089" target="_blank">Glib 主事件循环轻度分析与编程应用</a></li></ul><ul><li><a href="https://docs.gtk.org/glib/struct.SourceFuncs.html" target="_blank">gtk docs</a></li></ul><ul><li><a href="https://blog.csdn.net/CaspianSea/article/details/48775161" target="_blank">GLib 创建自定义事件源</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/虚拟化技术" >虚拟化技术</a></li></ul><ul><li><a href="../../md-docs/内存虚拟化" >内存虚拟化</a></li></ul><ul><li><a href="../../md-docs/CPU虚拟化" >CPU虚拟化</a></li></ul><ul><li><a href="../../md-docs/IO虚拟化" >IO虚拟化</a></li></ul><ul><li><a href="../../md-docs/网络虚拟化" >网络虚拟化</a></li></ul><ul><li><a href="../../qemu/intro" >qemu</a><ul><li><a href="../../qemu/intro" >intro</a></li></ul><ul><li><a href="../../qemu/glib" >glib</a></li></ul><ul><li><a href="../../qemu/qom" >qom</a></li></ul><ul><li><a href="../../qemu/system" >system</a></li></ul><ul><li><a href="../../qemu/tcg" >tcg</a></li></ul><ul><li><a href="../../qemu/vhost-user" >vhost-user</a></li></ul><ul><li><a href="../../qemu/EPT" >EPT</a></li></ul><ul><li><a href="../../qemu/machine" >machine</a></li></ul><ul><li><a href="../../qemu/args" >args</a></li></ul><ul><li><a href="../../qemu/contribute" >contribute</a></li></ul></li></ul><ul><li><a href="../../kvm/intro" >kvm</a><ul><li><a href="../../kvm/intro" >intro</a></li></ul></li></ul><ul><li><a href="../../cxl/intro" >cxl</a><ul><li><a href="../../cxl/intro" >intro</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../qemu/intro","../../qemu/qom","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>