<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/txt.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/qemu.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">system</a><ul><li><a href="#h2-1">初探主循环</a></li></ul><ul><li><a href="#h2-2">系统初始化</a><ul><li><a href="#h3-3">qemu_add_opts</a></li></ul><ul><li><a href="#h3-4">lookup_opt</a></li></ul></li></ul><ul><li><a href="#h2-5">device</a></li></ul><ul><li><a href="#h2-6">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">system</h1><blockquote><p>qemu 中使用了很多 glib 提供的函数, 阅读本文之前请先阅读 <a href="../../qemu/glib" target="_self">glib</a></p></blockquote><p>qemu 的代码写的还是很简洁的, <del>相比于 kernel</del>阅读和调试起来都比较友好</p><p>qemu 可以进行用户模式的仿真也可以进行系统的仿真, 系统级别的仿真会模拟 CPU/内存/磁盘/外设等等, 本节主要研究 <code>qemu-system-*</code> 的函数逻辑, 其主函数入口位于 <code>system/main.c</code></p><p>主函数首先调用 <code>qemu_init</code> 读取所有参数并初始化整个系统, 然后进入 <code>qemu_main_loop</code>, 当终止时做清理工作</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">qemu_default_main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">status</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_main_loop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_cleanup</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionP ID">qemu_main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">qemu_default_main</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier FunctionP PrimaryExpression ID">qemu_main</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-1">初探主循环</h2><p>正如一个操作系统内核的实现, 系统初始化的部分固然重要, 但是也仅仅初始化一次, 系统的主体循环部分才是模拟的重点.</p><p>qemu 采用 C 实现, 但是设计了大量的数据结构用于面向对面编程(OOP)的思想, 先来介绍一下主体逻辑</p><p><code>qemu_main_loop</code> 中 while 循环判断是否结束, 每一次循环中持续等待. 循环结束后将 <code>status</code> 交由 <code>qemu_cleanup</code> 完成收尾工作</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">qemu_main_loop</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">status</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXIT_SUCCESS</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">main_loop_should_exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">main_loop_wait</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">status</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>判断是否终止的函数有点长, 但是可以通过其返回的位置判断, 只在 <code>shutdown_request()</code> 为 TRUE 时退出, 将退出状态(status)带出并返回 true, 其余情况均返回 false. 即用户通过 <kbd>ctrl</kbd> + <kbd>a</kbd> + <kbd>x</kbd> 等方式终止时</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main_loop_should_exit</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">status</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">RunState</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">r</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 运行状态</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">ShutdownCause</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">request</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 关机请求的原因</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// 如果收到调试请求,则停止虚拟机并进入调试状态</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_debug_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vm_stop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUN_STATE_DEBUG</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 如果收到挂起请求,则挂起系统</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_suspend_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_system_suspend</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 检查是否有关机请求</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_shutdown_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_kill_report</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 报告关机事件</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_system_shutdown</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 执行系统关机</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// 如果关机动作是暂停,则停止虚拟机</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">shutdown_action</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine EQ">==</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">SHUTDOWN_ACTION_PAUSE</span><span class="Token SelectionStatement BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 HighlightLine LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">vm_stop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">RUN_STATE_SHUTDOWN</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 HighlightLine RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE"> </span><span class="Token Keyword SelectionStatement HighlightLine ELSE">else</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 HighlightLine LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">            </span><span class="Token CompoundStatement SelectionStatement HighlightLine COMMENT">// 根据不同的关机原因设置退出状态码</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">            </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">shutdown_exit_code</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine NE">!=</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">EXIT_SUCCESS</span><span class="Token SelectionStatement BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 HighlightLine LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">                </span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">status</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">shutdown_exit_code</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 HighlightLine RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE"> </span><span class="Token Keyword SelectionStatement HighlightLine ELSE">else</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement SelectionStatement BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">request</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp BinaryOp HighlightLine EQ">==</span><span class="Token BinaryOp BinaryOp HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">SHUTDOWN_CAUSE_GUEST_PANIC</span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression HighlightLine LF">
</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE">                </span><span class="Token Identifier PrimaryExpression HighlightLine ID">panic_action</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp HighlightLine EQ">==</span><span class="Token BinaryOp HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">PANIC_ACTION_EXIT_FAILURE</span><span class="Token SelectionStatement SelectionStatement BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token SelectionStatement SelectionStatement HighlightLine SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 HighlightLine LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">                </span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">status</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression HighlightLine ID">EXIT_FAILURE</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 HighlightLine RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">            </span><span class="Token Keyword JumpStatement HighlightLine RETURN">return</span><span class="Token Keyword JumpStatement HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine TRUE">true</span><span class="Token JumpStatement HighlightLine SEMI">;</span><span class="Token JumpStatement HighlightLine SPACE"> </span><span class="Token JumpStatement HighlightLine COMMENT">// 返回true,表示主循环应该退出</span><span class="Token JumpStatement HighlightLine LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 检查是否有重置请求</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_reset_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">pause_all_vcpus</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 暂停所有虚拟CPU</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_system_reset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">request</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 执行系统重置</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">resume_all_vcpus</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 恢复所有虚拟CPU</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// 运行状态可以在pause_all_vcpus中改变</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">runstate_check</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUN_STATE_RUNNING</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">                </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">runstate_check</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUN_STATE_INMIGRATE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">                </span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall ID">runstate_check</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUN_STATE_FINISH_MIGRATE</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">runstate_set</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUN_STATE_PRELAUNCH</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 设置运行状态为预启动</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 检查是否有唤醒请求</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_wakeup_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">pause_all_vcpus</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 暂停所有虚拟CPU</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_system_wakeup</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 执行系统唤醒</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">notifier_list_notify</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">wakeup_notifiers</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">wakeup_reason</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 通知唤醒事件</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">wakeup_reason</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">QEMU_WAKEUP_REASON_NONE</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 重置唤醒原因</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">resume_all_vcpus</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 恢复所有虚拟CPU</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qapi_event_send_wakeup</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 发送唤醒事件</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 检查是否有电源关闭请求</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_powerdown_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_system_powerdown</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 执行系统电源关闭</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 检查是否有虚拟机停止请求</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_vmstop_requested</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">vm_stop</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 停止虚拟机</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement SPACE"> </span><span class="Token JumpStatement COMMENT">// 返回false,表示主循环不应该退出</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>循环主体 <code>main_loop_wait</code> 负责等待和处理事件循环中的事件.这个函数使用多路复用(poll)机制来等待事件,并在事件到达时进行处理.</p><p>其中的 gpollfds, 非阻塞(nonblocking)时 timeout=0 为 Glib 事件循环的内容, 在 <a href="../../qemu/glib" target="_self">glib</a> 中已有介绍</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">main_loop_wait</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">nonblocking</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// 定义并初始化MainLoopPoll结构</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">MainLoopPoll</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mlpoll</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">        </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">state</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAIN_LOOP_POLL_FILL</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token COMMENT">// 设置初始状态为FILL</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">timeout</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">UINT32_MAX</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token COMMENT">// 设置超时时间为最大值</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">pollfds</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">gpollfds</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator COMMENT">// 使用全局poll文件描述符数组</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Initializer InitDeclarator BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ret</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">int64_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">timeout_ns</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// 如果是非阻塞模式,将超时时间设为0</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">nonblocking</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">timeout</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token CompoundStatement SelectionStatement HighlightLine COMMENT">// 处理任何事件</span><span class="Token CompoundStatement SelectionStatement HighlightLine LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">g_array_set_size</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">gpollfds</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine SPACE"> </span><span class="Token ExpressionStatement HighlightLine COMMENT">// 重置poll文件描述符数组的大小以进行新一轮迭代</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token ExpressionStatement HighlightLine COMMENT">// 通知所有main_loop_poll_notifiers</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">notifier_list_notify</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">main_loop_poll_notifiers</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 根据超时时间设置timeout_ns</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">timeout</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">UINT32_MAX</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">timeout_ns</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 无限等待</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">timeout_ns</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token CastExpression BinaryOp BraceDepth-2 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token CastExpression BinaryOp BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">timeout</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression MUL">*</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">int64_t</span><span class="Token CastExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">SCALE_MS</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">// 转换为纳秒</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 获取最早的定时器超时时间</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">timeout_ns</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_soonest_timeout</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">timeout_ns</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                                      </span><span class="Token Identifier PrimaryExpression FunctionCall ID">timerlistgroup_deadline_ns</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                                          </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">main_loop_tlg</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 进行系统级的事件等待</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">os_host_main_loop_wait</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">timeout_ns</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 根据等待结果设置mlpoll的状态</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">state</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression QUESTION">?</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAIN_LOOP_POLL_ERR</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression COLON">:</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAIN_LOOP_POLL_OK</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 通知所有main_loop_poll_notifiers</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">notifier_list_notify</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">main_loop_poll_notifiers</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">mlpoll</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 如果启用了icount模式,启动warp定时器</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">icount_enabled</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">/*
         * CPU线程可能会在错过warp后无限等待事件
         */</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">icount_start_warp_timer</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 运行所有的定时器</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_clock_run_all_timers</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>简单阅读主循环函数代码之后对整个系统有了一个初步的概念, qemu 是一个<b>事件驱动</b>的模拟器, 其运行主要依赖于事件的处理和调度,而不是通过一个持续的循环或固定的时间步长来进行处理. 事件驱动模型使得 qemu 能够高效地管理和响应多种异步事件,如I/O操作、定时器事件、中断和用户输入等</p><p>对于 system 级别的模拟, 包括 CPU/memory/device 等都有对应的模拟事件和计时器, 当事件发生以及处理完毕之后还会通知所有 <code>notifier</code> 来进一步响应.</p><p>qemu 的函数命名很规范, 封装的也很好, 初次阅读不易过于深入, 在详细介绍系统初始化关键数据结构之后会 &quot;再谈主循环&quot;</p><h2 id="h2-2">系统初始化</h2><p>系统初始化的过程主要分为四个阶段</p><ol start="1"><li>初始化一些默认配置信息和全局变量</li></ol><ol start="2"><li>初次尝试匹配参数, 对于一些不合法的参数直接报错</li></ol><ol start="3"><li>再次尝试匹配参数, 将参数信息收集并记录到对应的变量中</li></ol><ol start="4"><li>初始化整个系统</li></ol><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">qemu_init</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// 初始化一些默认配置</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_add_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">qemu_drive_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_add_drive_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">qemu_legacy_drive_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_add_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">qemu_accel_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_add_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">qemu_mem_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// 初次尝试匹配参数</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">lookup_opt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement SWITCH">switch</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">index</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword LabeledStatement CASE">case</span><span class="Token Keyword LabeledStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_nouserconfig</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">userconfig</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement COMMENT">// 再次尝试匹配参数, 处理对应 case</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">lookup_opt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement SWITCH">switch</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">index</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">          </span><span class="Token Keyword LabeledStatement CASE">case</span><span class="Token Keyword LabeledStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_cpu</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token LabeledStatement COMMENT">// do something</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement LabeledStatement SEMI">;</span><span class="Token JumpStatement LabeledStatement LF">
</span><span class="Token JumpStatement LabeledStatement SPACE">          </span><span class="Token Keyword LabeledStatement CASE">case</span><span class="Token Keyword LabeledStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_kernel</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qdict_put_str</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">machine_opts_dict</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;kernel&quot;</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">          </span><span class="Token Keyword LabeledStatement CASE">case</span><span class="Token Keyword LabeledStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_drive</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">opts</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_opts_parse_noisily</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_find_opts</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;drive&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression LF">
</span><span class="Token PostfixExpression UnaryExpression SPACE">                                           </span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">opts</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression FunctionCall ID">exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">qemu_create_machine</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">machine_opts_dict</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-3">qemu_add_opts</h3><p>在初始化的第一阶段是添加一些默认配置, 其中核心函数为 <code>qemu_add_opts</code>, 调用该函数传递的参数均是以 <code>*_opts</code> 结尾的全局变量指针</p><p>该函数的实现并不复杂, 只是在全局变量 <code>vm_config_groups</code> 中找到第一个非空的位置然后保存 list 指针. 另一个全局变量 <code>drive_config_groups</code> 则是为 <code>qemu_add_drive_opts</code> 来服务的</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QemuOptsList</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">vm_config_groups</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">48</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QemuOptsList</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">drive_config_groups</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">5</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType VOID">void</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">qemu_add_opts</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QemuOptsList</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">list</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">entries</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">entries</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ARRAY_SIZE</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">vm_config_groups</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">entries</span><span class="Token PostfixExpression UnaryExpression DEC">--</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement SPACE"> </span><span class="Token ExpressionStatement COMMENT">/* keep list NULL terminated */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">entries</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">vm_config_groups</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">vm_config_groups</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">list</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">fprintf</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">stderr</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token String STRING">&quot;ran out of space in vm_config_groups&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">abort</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>简单来说开头的一大段就是将所有的全局变量 <code>qemu_*_opts</code> 保存到 vm_config_groups 中以便后续处理, 以 <code>qemu_device_opts</code> 为例, 其中 <code>head</code> 字段采用的是循环引用</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_HEAD_INITIALIZER</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token ControlLine SPACE">                                   </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">        </span><span class="Token PPtoken BraceDepth-0 LCURLY_BRACE">{</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken DOT">.</span><span class="Token Identifier ID">tqh_circ</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken ASSIGN">=</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BraceDepth-1 LCURLY_BRACE">{</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier MacroDefine ID">NULL</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken AMPERSAND">&amp;</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token PPtoken DOT">.</span><span class="Token Identifier ID">tqh_circ</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken BraceDepth-1 RCURLY_BRACE">}</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BraceDepth-0 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QemuOptsList</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">qemu_device_opts</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">name</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token String STRING">&quot;device&quot;</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">implied_opt_name</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token String STRING">&quot;driver&quot;</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">head</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token MarcroFunction Identifier MarcroFunction PrimaryExpression ID">QTAILQ_HEAD_INITIALIZER</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">qemu_device_opts</span><span class="Token PPtoken DOT">.</span><span class="Token Identifier ID">head</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">desc</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Initializer DesignationInitializer BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer DesignationInitializer LF">
</span><span class="Token Initializer DesignationInitializer SPACE">        </span><span class="Token Initializer DesignationInitializer COMMENT">/*
         * no elements =&gt; accept any
         * sanity checking will happen later
         * when setting device properties
         */</span><span class="Token Initializer DesignationInitializer LF">
</span><span class="Token Initializer DesignationInitializer SPACE">        </span><span class="Token Initializer DesignationInitializer BraceDepth-2 LCURLY_BRACE">{</span><span class="Token Initializer DesignationInitializer SPACE"> </span><span class="Token Initializer DesignationInitializer COMMENT">/* end of list */</span><span class="Token Initializer DesignationInitializer SPACE"> </span><span class="Token Initializer DesignationInitializer BraceDepth-2 RCURLY_BRACE">}</span><span class="Token Initializer DesignationInitializer LF">
</span><span class="Token Initializer DesignationInitializer SPACE">    </span><span class="Token Initializer DesignationInitializer BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p><code>QemuOptsList</code> 中的 <code>head</code> 字段是一个比较有意思的设计, 其采用双向链表, 这种设计主要是为了在编写代码时可以通用化的处理</p><pre class="language-c"><code><span class="Token COMMENT">/*
 * Tail queue definitions.  The union acts as a poor man template, as if
 * it were QTailQLink&lt;type&gt;.
 */</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_HEAD</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">name</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">type</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token ControlLine SPACE">                                         </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token Keyword UNION">union</span><span class="Token Keyword SPACE"> </span><span class="Token Identifier ID">name</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken BraceDepth-0 LCURLY_BRACE">{</span><span class="Token PPtoken SPACE">                                                            </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">        </span><span class="Token Keyword STRUCT">struct</span><span class="Token Keyword SPACE"> </span><span class="Token Identifier ID">type</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token Identifier ID">tqh_first</span><span class="Token PPtoken SEMI">;</span><span class="Token PPtoken SPACE">       </span><span class="Token PPtoken COMMENT">/* first element */</span><span class="Token PPtoken SPACE">               </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">        </span><span class="Token Identifier ID">QTailQLink</span><span class="Token Identifier SPACE"> </span><span class="Token Identifier ID">tqh_circ</span><span class="Token PPtoken SEMI">;</span><span class="Token PPtoken SPACE">          </span><span class="Token PPtoken COMMENT">/* link for circular backwards list */</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken BraceDepth-0 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">QemuOptsList</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword QualifyType TypeSpecifier CONST">const</span><span class="Token Keyword QualifyType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">name</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword QualifyType TypeSpecifier CONST">const</span><span class="Token Keyword QualifyType TypeSpecifier SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">implied_opt_name</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier BOOL">bool</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">merge_lists</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">  </span><span class="Token StructDeclaration COMMENT">/* Merge multiple uses of option into a single list? */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token MarcroFunction Identifier Typedefine MacroInvocation TypeSpecifier ID">QTAILQ_HEAD</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">QemuOpts</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">head</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier TYPEDEF_ID">QemuOptDesc</span><span class="Token Keyword Typedefine TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">desc</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">QTailQLink</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Structure BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Structure LF">
</span><span class="Token Structure SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">tql_next</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier ID">QTailQLink</span><span class="Token Identifier Structure StructureClass TypeSpecifier TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor TypeSpecifier ID">tql_prev</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token Structure BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Structure SPACE">   </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">QTailQLink</span><span class="Token Declaration SEMI">;</span></code></pre><p>在 <code>include/qemu/queue.h</code> 该文件中定义了四种数据结构 <b>单向链表、(双向)链表、单向队列和尾(双向)队列</b>, 并包含了大量的宏处理, 以本例中的尾队列为例</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_INSERT_HEAD</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">elm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_INSERT_TAIL</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">elm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_INSERT_AFTER</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">listelm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">elm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_INSERT_BEFORE</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">listelm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">elm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_REMOVE</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">head</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">elm</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token Identifier MacroDefine ControlLine MarcroFunction ID">QTAILQ_FOREACH</span><span class="Token ControlLine BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">var</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">head</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">field</span><span class="Token ControlLine BraceDepth-0 RPAREN">)</span></code></pre><h3 id="h3-4">lookup_opt</h3><p>配置初始化之后会尝试第一次解析参数, 遍历每一个 argv 并调用 <code>lookup_opt</code> 进行解析</p><pre class="language-c"><code><span class="Token COMMENT">/* first pass of option parsing */</span><span class="Token LF">
</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token IterationStatement BraceDepth-0 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression NE">!=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Char PrimaryExpression CHARACTER">&#x27;-&#x27;</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">/* disk image */</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QEMUOption</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">popt</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">popt</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">lookup_opt</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">argc</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">argv</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">optarg</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">optind</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement SWITCH">switch</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">index</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword LabeledStatement CASE">case</span><span class="Token Keyword LabeledStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_nouserconfig</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">userconfig</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression FALSE">false</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement IterationStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>该函数本身也并不复杂, 值得一提的是 qemu 推荐的传参方式不同于大多数软件采用的 <code>--</code> 传递的长参数, 而普遍采用单 <code>-</code> 的长参数, 例如 <code>-kernel</code> <code>-initrd</code>, 不过在代码中可以看到也对于 <code>--</code> 的参数传递做了 <code>r++</code> 的处理.</p><p>循环主体部分就是依次遍历判断所有的 <code>qemu_options</code> 的名字是否相同</p><pre class="language-c"><code><span class="Token Keyword StorageType FunctionReturnType STATIC">static</span><span class="Token Keyword StorageType FunctionReturnType SPACE"> </span><span class="Token Keyword QualifyType FunctionReturnType CONST">const</span><span class="Token Keyword QualifyType FunctionReturnType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">QEMUOption</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">lookup_opt</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">                                    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">poptarg</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">poptind</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QEMUOption</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">popt</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">optind</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">poptind</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">r</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">optarg</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression FunctionCall ID">loc_set_cmdline</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">/* Treat --foo the same as -foo.  */</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">r</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LSQUAR_PAREN">[</span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine EQ">==</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Char PrimaryExpression HighlightLine CHARACTER">&#x27;-&#x27;</span><span class="Token SelectionStatement BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">r</span><span class="Token PostfixExpression UnaryExpression HighlightLine INC">++</span><span class="Token ExpressionStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement SelectionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">qemu_options</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token UnaryOp UnaryExpression BANG">!</span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">name</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">error_report</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;invalid option&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Keyword SelectionStatement HighlightLine IF">if</span><span class="Token Keyword SelectionStatement HighlightLine SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine BANG">!</span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">strcmp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">popt</span><span class="Token PostfixExpression UnaryExpression HighlightLine POINT">-&gt;</span><span class="Token Identifier HighlightLine ID">name</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression HighlightLine ID">r</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token BinaryOp ConditionalExpression HighlightLine PLUS">+</span><span class="Token BinaryOp ConditionalExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 HighlightLine RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token SelectionStatement HighlightLine LF">
</span><span class="Token SelectionStatement HighlightLine SPACE">            </span><span class="Token Keyword JumpStatement HighlightLine BREAK">break</span><span class="Token JumpStatement SelectionStatement HighlightLine SEMI">;</span><span class="Token JumpStatement SelectionStatement HighlightLine LF">
</span><span class="Token JumpStatement SelectionStatement HighlightLine SPACE">        </span><span class="Token Identifier PrimaryExpression HighlightLine ID">popt</span><span class="Token PostfixExpression UnaryExpression HighlightLine INC">++</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">flags</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">HAS_ARG</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression GE">&gt;=</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argc</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">error_report</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;requires an argument&quot;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">exit</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">loc_set_cmdline</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">argv</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">2</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">2</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">poptarg</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">optarg</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">poptind</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">optind</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">popt</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>这里的 <code>qemu_options</code> 稍微有点意思, 改变量结合 C 预处理器来完成对于文件 &quot;qemu-options.def&quot; 内容的导入, 该文件会在编译时生成, 文件内容就是 DEF 这些宏的使用, 然后匹配其中的 <code>.name</code> 字段</p><pre class="language-c"><code><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">QEMUOption</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">qemu_options</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token DirectDeclaractorPostfix SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Initializer DesignationInitializer BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer DesignationInitializer SPACE"> </span><span class="Token String STRING">&quot;h&quot;</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier PrimaryExpression ID">QEMU_OPTION_h</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">QEMU_ARCH_ALL</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token Initializer DesignationInitializer BraceDepth-1 RCURLY_BRACE">}</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token MarcroFunction Identifier MarcroFunction ControlLine MarcroFunction ID">DEF</span><span class="Token ControlLine BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">option</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">opt_arg</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">opt_enum</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">opt_help</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">arch_mask</span><span class="Token ControlLine BraceDepth-1 RPAREN">)</span><span class="Token ControlLine SPACE">     </span><span class="Token PPtoken BACK_SLASH">\</span><span class="Token PPtoken LF">
</span><span class="Token PPtoken SPACE">    </span><span class="Token PPtoken BraceDepth-1 LCURLY_BRACE">{</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">option</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">opt_arg</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">opt_enum</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">arch_mask</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken BraceDepth-1 RCURLY_BRACE">}</span><span class="Token PPtoken COMMA">,</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token MarcroFunction Identifier MarcroFunction ControlLine MarcroFunction ID">DEFHEADING</span><span class="Token ControlLine BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">text</span><span class="Token ControlLine BraceDepth-1 RPAREN">)</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine DEFINE">define</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token MarcroFunction Identifier MarcroFunction ControlLine MarcroFunction ID">ARCHHEADING</span><span class="Token ControlLine BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">text</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier ID">arch_mask</span><span class="Token ControlLine BraceDepth-1 RPAREN">)</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword Preprocess ControlLine INCLUDE">include</span><span class="Token Keyword Preprocess ControlLine SPACE"> </span><span class="Token String HeaderName STRING">&quot;qemu-options.def&quot;</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Initializer DesignationInitializer BraceDepth-1 LCURLY_BRACE">{</span><span class="Token Initializer DesignationInitializer SPACE"> </span><span class="Token Initializer DesignationInitializer COMMENT">/* end of list */</span><span class="Token Initializer DesignationInitializer SPACE"> </span><span class="Token Initializer DesignationInitializer BraceDepth-1 RCURLY_BRACE">}</span><span class="Token Initializer DesignationInitializer LF">
</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240707140822.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240707140822.png" alt="20240707140822"></a></p><p>如果初次匹配通过则说明所有的<b>参数格式</b>都是合法的, 此时尝试进行进行二次匹配, 确定所有传参的字符串等是否合法</p><h2 id="h2-5">device</h2><pre class="language-txt"><code><span class="Token ID">main</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">main</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">qemu_init</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">vl</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">qmp_x_exit_preconfig</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">vl</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">      </span><span class="Token ID">qemu_create_cli_devices</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">vl</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token ID">qemu_opts_foreach</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">util</span><span class="Token DIV">/</span><span class="Token ID">qemu</span><span class="Token MINUS">-</span><span class="Token ID">option</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">          </span><span class="Token ID">device_init_func</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">vl</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">            </span><span class="Token ID">qdev_device_add</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">qdev</span><span class="Token MINUS">-</span><span class="Token ID">monitor</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">              </span><span class="Token ID">qdev_device_add_from_qdict</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">system</span><span class="Token DIV">/</span><span class="Token ID">qdev</span><span class="Token MINUS">-</span><span class="Token ID">monitor</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                </span><span class="Token ID">qdev_new</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">hw</span><span class="Token DIV">/</span><span class="Token ID">core</span><span class="Token DIV">/</span><span class="Token ID">qdev</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token ID">object_new</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                    </span><span class="Token ID">object_new_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                      </span><span class="Token ID">object_initialize_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                        </span><span class="Token ID">object_init_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                          </span><span class="Token ID">object_init_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                            </span><span class="Token ID">vhost_user_fs_pci_instance_init</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">hw</span><span class="Token DIV">/</span><span class="Token ID">virtio</span><span class="Token DIV">/</span><span class="Token ID">vhost</span><span class="Token MINUS">-</span><span class="Token ID">user</span><span class="Token MINUS">-</span><span class="Token ID">fs</span><span class="Token MINUS">-</span><span class="Token ID">pci</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                              </span><span class="Token ID">virtio_instance_init_common</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">hw</span><span class="Token DIV">/</span><span class="Token ID">virtio</span><span class="Token DIV">/</span><span class="Token ID">virtio</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                </span><span class="Token ID">object_initialize_child_with_props</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                  </span><span class="Token ID">object_initialize_child_with_propsv</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                    </span><span class="Token ID">object_initialize</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                      </span><span class="Token ID">object_initialize_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                        </span><span class="Token ID">object_init_with_type</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">qom</span><span class="Token DIV">/</span><span class="Token ID">object</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">                                          </span><span class="Token ID">vuf_instance_init</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">hw</span><span class="Token DIV">/</span><span class="Token ID">virtio</span><span class="Token DIV">/</span><span class="Token ID">vhost</span><span class="Token MINUS">-</span><span class="Token ID">user</span><span class="Token MINUS">-</span><span class="Token ID">fs</span><span class="Token DOT">.</span><span class="Token ID">c</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span></code></pre><p>qmp_x_exit_preconfig qemu_create_cli_devices</p><h2 id="h2-6">参考</h2><ul><li><a href="https://www.cnblogs.com/from-zero/p/12383652.html" target="_blank">菜鸡读QEMU源码</a></li></ul><ul><li><a href="https://lifeislife.cn/categories/QEMU-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank">lifeislife QEMU-源码分析</a></li></ul><ul><li><a href="https://blog.csdn.net/home19900111/article/details/127702727" target="_blank">QEMU代码详解</a> *</li></ul><ul><li><a href="https://blog.csdn.net/home19900111/category_12073604.html" target="_blank">虚拟化收纳箱</a></li></ul><ul><li><a href="https://blog.csdn.net/qq_37434641/article/details/139352019" target="_blank">【QEMU 中文文档】0. Hello QEMU!</a></li></ul><ul><li><a href="https://blog.csdn.net/kangkanglhb88008/article/details/126299695" target="_blank">qemu的详细资料大全(入门必看!!!)</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/28315265/how-to-add-a-new-device-in-qemu-source-code" target="_blank">how to add a new device in qemu source code</a></li></ul><ul><li><a href="https://blog.vmsplice.net/2011/03/qemu-internals-big-picture-overview.html" target="_blank">vmsplice blog</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/636763565" target="_blank">qemu源码分析(一)-- QOM类创建流程</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/637216343" target="_blank">qemu源码分析(二)-- QOM类设备初始化</a></li></ul><ul><li><a href="https://www.zhihu.com/column/c_1571975874009907200" target="_blank">虚拟仿真技术 专栏</a></li></ul><ul><li><a href="https://www.cnblogs.com/LoyenWang/p/13943005.html" target="_blank">【原创】Linux虚拟化KVM-Qemu分析(五)之内存虚拟化</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/contribute" >contribute</a></li></ul><ul><li><a href="../../virtual/虚拟化技术简介" >virtual</a><ul><li><a href="../../virtual/虚拟化技术简介" >虚拟化技术简介</a></li></ul><ul><li><a href="../../virtual/research" >research</a></li></ul><ul><li><a href="../../virtual/内存虚拟化" >内存虚拟化</a></li></ul><ul><li><a href="../../virtual/CPU虚拟化" >CPU虚拟化</a></li></ul><ul><li><a href="../../virtual/IO虚拟化" >IO虚拟化</a></li></ul><ul><li><a href="../../virtual/网络虚拟化" >网络虚拟化</a></li></ul><ul><li><a href="../../virtual/tools" >tools</a></li></ul><ul><li><a href="../../virtual/tier-mm" >tier-mm</a></li></ul></li></ul><ul><li><a href="../../qemu/intro" >qemu</a><ul><li><a href="../../qemu/intro" >intro</a></li></ul><ul><li><a href="../../qemu/glib" >glib</a></li></ul><ul><li><a href="../../qemu/qom" >qom</a></li></ul><ul><li><a href="../../qemu/system" >system</a></li></ul><ul><li><a href="../../qemu/tcg" >tcg</a></li></ul><ul><li><a href="../../qemu/vhost-user" >vhost-user</a></li></ul><ul><li><a href="../../qemu/EPT" >EPT</a></li></ul><ul><li><a href="../../qemu/machine" >machine</a></li></ul></li></ul><ul><li><a href="../../cxl/intro" >cxl</a><ul><li><a href="../../cxl/intro" >intro</a></li></ul></li></ul><ul><li><a href="../../kvm/intro" >kvm</a><ul><li><a href="../../kvm/intro" >intro</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../qemu/qom","../../qemu/tcg","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>